<!DOCTYPE html>
<html>
<body>
<section id="main_view" style="display: none">
    <h1 id="title"></h1>
    <hr>
    <p id="description"></p>
    <p class="mono">üè† –û–±—ä–µ–∫—Ç:</p>
    <div class="custom-select">
        <div></div>
        <select id="objects-select" oninput="onTextInputChange()">
            <option value="">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</option>
        </select>
    </div>

    <p class="mono">üë§ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</p>
    <input class="text_input" type=text oninput="onTextInputChange()">

    <p class="mono">üíµ –°—É–º–º–∞:</p>
    <input class="text_input" type=number oninput="onTextInputChange()">

    <p class="mono">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</p>
    <textarea id="comment" class="text_input" rows="5" oninput="onTextInputChange()"></textarea>

    <p></p>
    <div id="button">
    </div>

</section>
</body>
<script>
    let text_inputs = [];
    $(".text_input").each(function (i, el) {
        text_inputs.push(el);
    });

    let request = {};
    $.when(getObjects(), getRequest()).then(() => {
        let send_button = '<button disabled id="save_btn" onclick="sendRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>'
        let edit_button = '<button disabled id="save_btn" onclick="editRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>'

        if (Object.keys(request).length === 0) {
            $('#title').html('–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏ –æ–ø–ª–∞—Ç—É');
            $('#description').html('–í—Å–µ –ø–æ–ª—è –Ω–∏–∂–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª, –∫–∞–∫ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã.<br><br>–ö–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –ø–æ–∫–∞ –æ–¥–Ω–æ –∏–∑ –ø–æ–ª–µ–π –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ.');
            $('#button').html($(send_button));

        } else {
            $('#title').html('–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
            $('#objects-select').val(request.object);
            text_inputs[0].value = request.counterparty;
            text_inputs[1].value = request.money;
            $('#comment').val(request.comment);
            $('#description').html('–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è¬ª, –∫–∞–∫ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã.');
            $('#button').html($(edit_button));
        }

        $('#main_view').fadeIn(100);
    })


    function areFieldsFilled() {
        for (let element of text_inputs) {
            let value = $(element).val();
            if (!value) {
                console.log(value);
                return false;
            }
        }
        return $('#objects-select').find(":selected").text() !== '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞';

    }


    function onTextInputChange() {
        if (areFieldsFilled()) {
            $('#save_btn').prop('disabled', false);
        } else {
            $('#save_btn').prop('disabled', true);
        }
    }

    function getObjects() {
        return ajax('/getObjects', {}, (result) => {
            let objects_select = $('#objects-select');
            result.objects.forEach((object) => {
                let r = $('<option value="' + object + '">' + object + '</option>');
                objects_select.append(r);
            });
        });
    }


    function editRequest() {
        $('#save_btn').prop('disabled', true);

        let data = {
            request_id: request.id,
            request: {
                object: $('#objects-select').find(":selected").text(),
                counterparty: text_inputs[0].value,
                money: text_inputs[1].value,
                comment: $(text_inputs[2]).val(),
            }
        };

        return ajax('/editRequest', data, () => {
            Telegram.WebApp.showAlert('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏ –æ–ø–ª–∞—Ç—É.\n\n–§–æ—Ä–º–∞ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∞.');
            Telegram.WebApp.close();
        });
    }

    function sendRequest() {
        $('#save_btn').prop('disabled', true);

        let data = {
            request: {
                object: $('#objects-select').find(":selected").text(),
                counterparty: text_inputs[0].value,
                money: text_inputs[1].value,
                comment: $(text_inputs[2]).val(),
            }
        };

        return ajax('/sendRequest', data, () => {
            Telegram.WebApp.showAlert('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏ –æ–ø–ª–∞—Ç—É. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞.\n–§–æ—Ä–º–∞ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∞.');
            Telegram.WebApp.close();
        });
    }
</script>
</html>